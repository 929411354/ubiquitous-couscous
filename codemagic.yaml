#!/bin/bash
# === æ­£ç¡®é…ç½®å‚æ•° ===
export CM_API_KEY="YRAU6tGcqouHDJ-AmbQi8A-aoU1pHsDMMR3ZQUJalSI"
export CM_APP_ID="687e3ce724817b83deea48d7"      # æ¥è‡ªæ‚¨çš„é“¾æ¥

# === ä¿®å¤JSONè¯­æ³•é”™è¯¯ ===
RESPONSE=$(curl -X POST \
  -H "Content-Type: application/json" \  # âœ… å¤§å†™Hï¼Œæ­£ç¡®å¼•å·
  -H "Authorization: Bearer $CM_API_KEY" \
  -d '{
    "appId": "'"$CM_APP_ID"'",
    "workflowId": "'"$CM_WORKFLOW_ID"'",
    "branch": "main",
    "environment": {
      "variables": {
        "IOS_SIGNING_TYPE": "development"
      }
    }
  }' \
  "https://api.codemagic.io/builds"
)

# === å¤„ç†JSONå“åº” ===
BUILD_ID=$(echo "$RESPONSE" | jq -r '.buildId')

# === å¢å¼ºé”™è¯¯å¤„ç† ===
if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
  echo "âŒ æ„å»ºå¯åŠ¨å¤±è´¥! é”™è¯¯ä¿¡æ¯:"
  echo "$RESPONSE" | jq .
  exit 1
fi

echo "âœ… æ„å»ºå·²å¯åŠ¨! ID: $BUILD_ID"
echo "ğŸ‘‰ æŸ¥çœ‹æ„å»ºçŠ¶æ€: https://codemagic.io/app/$CM_APP_ID/build/$BUILD_ID"

# === ä¸Šä¼ IPA ===
curl -X POST \
  -H "Authorization: Bearer $CM_API_KEY" \
  -F "file=@$IPA_PATH" \
  "https://api.codemagic.io/builds/$BUILD_ID/artifacts"

echo "âœ… IPAæ–‡ä»¶ä¸Šä¼ å®Œæˆ"