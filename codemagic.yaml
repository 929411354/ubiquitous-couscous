workflows:
  my-workflow:
    name: My Workflow
    environment:
      vars:
        CM_API_KEY: $CM_API_KEY
        CM_APP_ID: $CM_APP_ID
        CM_WORKFLOW_ID: $CM_WORKFLOW_ID   # æˆ–è€…ç›´æ¥å†™æ­»
        IPA_PATH: $IPA_PATH   # è¿™äº›å˜é‡å¯ä»¥åœ¨Codemagicçš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½®
    scripts:
      - name: Build and Upload
        script: |
          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CM_API_KEY" \
            -d '{
              "appId": "'"$CM_APP_ID"'",
              "workflowId": "'"$CM_WORKFLOW_ID"'",
              "branch": "main",
              "environment": {
                "variables": {
                  "IOS_SIGNING_TYPE": "development"
                }
              }
            }' \
            "https://api.codemagic.io/builds"
          )

          BUILD_ID=$(echo "$RESPONSE" | jq -r '.buildId')

          if [ -z "$BUILD_ID" ] || [ "$BUILD_ID" = "null" ]; then
            echo "âŒ æ„å»ºå¯åŠ¨å¤±è´¥! é”™è¯¯ä¿¡æ¯:"
            echo "$RESPONSE" | jq .
            exit 1
          fi

          echo "âœ… æ„å»ºå·²å¯åŠ¨! ID: $BUILD_ID"
          echo "ğŸ‘‰ æŸ¥çœ‹æ„å»ºçŠ¶æ€: https://codemagic.io/app/$CM_APP_ID/build/$BUILD_ID"

          curl -X POST \
            -H "Authorization: Bearer $CM_API_KEY" \
            -F "file=@$IPA_PATH" \
            "https://api.codemagic.io/builds/$BUILD_ID/artifacts"

          echo "âœ… IPAæ–‡ä»¶ä¸Šä¼ å®Œæˆ"